<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°å¡”çš„ SOP ç®¡ç†</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#8b5cf6">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
            accent: { primary: '#8b5cf6', secondary: '#06b6d4' }
          }
        }
      }
    }
  </script>
  <style>
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      min-height: 100vh;
    }
    .card {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.2);
    }
    .sop-item:hover {
      transform: translateX(4px);
      border-color: rgba(139, 92, 246, 0.5);
    }
    .editor {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
  </style>
</head>
<body class="text-gray-100">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- æ ‡é¢˜å’Œè¿”å›æŒ‰é’® -->
    <div class="flex items-center justify-between mb-8">
      <div class="flex-1 text-center">
        <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-purple-400 to-cyan-400 bg-clip-text text-transparent">
          ğŸ“š å°å¡”çš„ SOP ç®¡ç†
        </h1>
        <p class="text-gray-400 mt-2">å¯è§†åŒ–ç®¡ç†å’ŒæŸ¥çœ‹æ ‡å‡†æ“ä½œæµç¨‹</p>
      </div>
      <a href="/" class="flex-shrink-0 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-bold rounded-lg transition-colors">
        ğŸ  è¿”å›ä¸»é¡µ
      </a>
    </div>

    <!-- æ“ä½œæ  -->
    <div class="flex flex-wrap gap-4 mb-6">
      <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢ SOP..." 
        class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:border-purple-500 focus:outline-none"
        oninput="filterSOPList()">
      <button onclick="showCreateModal()" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition-colors">
        â• æ–°å¢ SOP
      </button>
    </div>

    <!-- SOP åˆ—è¡¨ -->
    <div id="sopList" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
      <!-- åŠ è½½ä¸­ -->
      <div class="col-span-full text-center py-12 text-gray-400">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-purple-500 border-t-transparent"></div>
        <p class="mt-4">åŠ è½½ä¸­...</p>
      </div>
    </div>
  </div>

  <!-- æŸ¥çœ‹/ç¼–è¾‘ SOP Modal -->
  <div id="sopModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4">
    <div class="bg-gray-800 rounded-2xl w-full max-w-5xl h-[85vh] flex flex-col">
      <div class="flex items-center justify-between p-4 border-b border-gray-700 flex-shrink-0">
        <h2 id="modalTitle" class="text-xl font-bold text-purple-400">æŸ¥çœ‹ SOP</h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div class="flex-1 overflow-hidden flex flex-col p-4 min-h-0">
        <textarea id="sopEditor" class="editor flex-1 w-full bg-gray-900 border border-gray-700 rounded-lg p-4 text-white text-sm resize-none focus:border-purple-500 focus:outline-none leading-relaxed" spellcheck="false" style="min-height: 400px;"></textarea>
      </div>
      <div class="flex items-center justify-between p-4 border-t border-gray-700 flex-shrink-0">
        <button onclick="deleteSOP()" id="deleteBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors">
          ğŸ—‘ï¸ åˆ é™¤
        </button>
        <div class="flex gap-4">
          <button onclick="closeModal()" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg transition-colors">
            å–æ¶ˆ
          </button>
          <button onclick="saveSOP()" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition-colors">
            ğŸ’¾ ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ–°å¢ SOP Modal -->
  <div id="createModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4">
    <div class="bg-gray-800 rounded-2xl w-full max-w-lg">
      <div class="flex items-center justify-between p-4 border-b border-gray-700">
        <h2 class="text-xl font-bold text-purple-400">æ–°å¢ SOP</h2>
        <button onclick="closeCreateModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div class="p-4 space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">æ–‡ä»¶åï¼ˆè‹±æ–‡ï¼‰</label>
          <input type="text" id="newFileName" placeholder="ä¾‹å¦‚: deploy-app.md" 
            class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white focus:border-purple-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-1">SOP æ ‡é¢˜</label>
          <input type="text" id="newTitle" placeholder="ä¾‹å¦‚: éƒ¨ç½²åº”ç”¨æµç¨‹" 
            class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white focus:border-purple-500 focus:outline-none">
        </div>
      </div>
      <div class="flex justify-end gap-4 p-4 border-t border-gray-700">
        <button onclick="closeCreateModal()" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg transition-colors">
          å–æ¶ˆ
        </button>
        <button onclick="createSOP()" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition-colors">
          â• åˆ›å»º
        </button>
      </div>
    </div>
  </div>

  <!-- æ¶ˆæ¯æç¤º -->
  <div id="message" class="hidden fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white font-bold"></div>

  <script>
    let sopList = [];
    let currentSOP = null;

    // åŠ è½½ SOP åˆ—è¡¨
    async function loadSOPList() {
      try {
        const response = await fetch('/api/sop-manager/list');
        const result = await response.json();
        if (result.success) {
          sopList = result.data;
          renderSOPList();
        } else {
          showMessage('åŠ è½½å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
      }
    }

    // æ¸²æŸ“ SOP åˆ—è¡¨
    function renderSOPList(filter = '') {
      const container = document.getElementById('sopList');
      const filtered = sopList.filter(sop => 
        sop.title.toLowerCase().includes(filter.toLowerCase()) ||
        sop.name.toLowerCase().includes(filter.toLowerCase())
      );

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-12 text-gray-500">
            <span class="text-4xl">ğŸ“­</span>
            <p class="mt-2">æ²¡æœ‰æ‰¾åˆ° SOP</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filtered.map(sop => `
        <div class="card sop-item rounded-xl p-4 cursor-pointer transition-all" onclick="viewSOP('${sop.name}')">
          <div class="flex items-start gap-3">
            <span class="text-2xl">ğŸ“„</span>
            <div class="flex-1 min-w-0">
              <h3 class="font-bold text-purple-400 truncate">${sop.title}</h3>
              <p class="text-gray-500 text-sm truncate">${sop.name}</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    // æœç´¢è¿‡æ»¤
    function filterSOPList() {
      const query = document.getElementById('searchInput').value;
      renderSOPList(query);
    }

    // æŸ¥çœ‹ SOP
    async function viewSOP(filename) {
      try {
        const response = await fetch('/api/sop-manager/content?file=' + encodeURIComponent(filename));
        const result = await response.json();
        if (result.success) {
          currentSOP = filename;
          document.getElementById('modalTitle').textContent = result.data.title;
          document.getElementById('sopEditor').value = result.data.content;
          document.getElementById('deleteBtn').dataset.file = filename;
          document.getElementById('sopModal').classList.remove('hidden');
          document.getElementById('sopModal').classList.add('flex');
        } else {
          showMessage('åŠ è½½å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
      }
    }

    // ä¿å­˜ SOP
    async function saveSOP() {
      if (!currentSOP) return;
      const content = document.getElementById('sopEditor').value;
      
      try {
        const response = await fetch('/api/sop-manager/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ file: currentSOP, content })
        });
        const result = await response.json();
        if (result.success) {
          showMessage('âœ… ä¿å­˜æˆåŠŸï¼', 'success');
          closeModal();
          loadSOPList();
        } else {
          showMessage('âŒ ä¿å­˜å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    }

    // åˆ é™¤ SOP
    async function deleteSOP() {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª SOP å—ï¼Ÿ')) return;
      const filename = document.getElementById('deleteBtn').dataset.file;
      
      try {
        const response = await fetch('/api/sop-manager/delete?file=' + encodeURIComponent(filename), { method: 'DELETE' });
        const result = await response.json();
        if (result.success) {
          showMessage('âœ… åˆ é™¤æˆåŠŸï¼', 'success');
          closeModal();
          loadSOPList();
        } else {
          showMessage('âŒ åˆ é™¤å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('âŒ åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ˜¾ç¤ºæ–°å¢ Modal
    function showCreateModal() {
      document.getElementById('newFileName').value = '';
      document.getElementById('newTitle').value = '';
      document.getElementById('createModal').classList.remove('hidden');
      document.getElementById('createModal').classList.add('flex');
    }

    // å…³é—­æ–°å¢ Modal
    function closeCreateModal() {
      document.getElementById('createModal').classList.add('hidden');
      document.getElementById('createModal').classList.remove('flex');
    }

    // åˆ›å»º SOP
    async function createSOP() {
      const filename = document.getElementById('newFileName').value.trim();
      const title = document.getElementById('newTitle').value.trim();
      
      if (!filename || !filename.endsWith('.md')) {
        showMessage('âŒ æ–‡ä»¶åå¿…é¡»ä»¥ .md ç»“å°¾', 'error');
        return;
      }
      if (!title) {
        showMessage('âŒ è¯·è¾“å…¥æ ‡é¢˜', 'error');
        return;
      }

      const content = `# ${title}\n\n## æ¦‚è¿°\n\nè¯·åœ¨æ­¤å¤„å¡«å†™æ“ä½œæµç¨‹...\n\n## æ­¥éª¤\n\n1. \n2. \n3. \n`;

      try {
        const response = await fetch('/api/sop-manager/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ file: filename, content })
        });
        const result = await response.json();
        if (result.success) {
          showMessage('âœ… åˆ›å»ºæˆåŠŸï¼', 'success');
          closeCreateModal();
          loadSOPList();
        } else {
          showMessage('âŒ åˆ›å»ºå¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('âŒ åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
      }
    }

    // å…³é—­ Modal
    function closeModal() {
      document.getElementById('sopModal').classList.add('hidden');
      document.getElementById('sopModal').classList.remove('flex');
      currentSOP = null;
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(text, type) {
      const el = document.getElementById('message');
      el.textContent = text;
      el.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg font-bold ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    }

    // åˆå§‹åŒ–
    loadSOPList();
  </script>
</body>
</html>
